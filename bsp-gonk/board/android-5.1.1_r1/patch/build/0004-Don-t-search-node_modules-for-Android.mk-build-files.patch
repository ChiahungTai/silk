From 1f3f625682f79b4c8698dc79fec3268862ab91ac Mon Sep 17 00:00:00 2001
From: Michael Vines <mvines@silklabs.com>
Date: Sun, 10 Jan 2016 19:42:03 -0800
Subject: [PATCH] Don't search node_modules/ for Android.mk build files

These are upstream npm things and there can be a lot of them.  Without this
pruning the initial build startup time can be severely impacted.
---
 core/cleanspec.mk   | 2 +-
 core/definitions.mk | 2 +-
 core/main.mk        | 2 +-
 3 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/core/cleanspec.mk b/core/cleanspec.mk
index 500ce54..19dcbad 100644
--- a/core/cleanspec.mk
+++ b/core/cleanspec.mk
@@ -64,6 +64,6 @@ INTERNAL_CLEAN_BUILD_VERSION := 6
 # ************************************************
 
 subdir_cleanspecs := \
-    $(shell build/tools/findleaves.py --prune=$(OUT_DIR) --prune=.repo --prune=.git . CleanSpec.mk)
+    $(shell build/tools/findleaves.py --prune=$(OUT_DIR) --prune=.repo --prune=.git --prune=node_modules . CleanSpec.mk)
 include $(subdir_cleanspecs)
 subdir_cleanspecs :=
diff --git a/core/definitions.mk b/core/definitions.mk
index 38aa720..4406d7b 100644
--- a/core/definitions.mk
+++ b/core/definitions.mk
@@ -151,7 +151,7 @@ endef
 # Ignores $(1)/Android.mk
 define first-makefiles-under
 $(shell build/tools/findleaves.py --prune=$(OUT_DIR) --prune=.repo --prune=.git \
-        --mindepth=2 $(1) Android.mk)
+        --prune=node_modules --mindepth=2 $(1) Android.mk)
 endef
 
 ###########################################################
diff --git a/core/main.mk b/core/main.mk
index 784c9d1..7642a54 100644
--- a/core/main.mk
+++ b/core/main.mk
@@ -523,7 +523,7 @@ ifneq ($(dont_bother),true)
 # Can't use first-makefiles-under here because
 # --mindepth=2 makes the prunes not work.
 subdir_makefiles := \
-	$(shell build/tools/findleaves.py --prune=$(OUT_DIR) --prune=.repo --prune=.git $(subdirs) Android.mk)
+	$(shell build/tools/findleaves.py --prune=$(OUT_DIR) --prune=.repo --prune=.git --prune=node_modules $(subdirs) Android.mk)
 
 $(foreach mk, $(subdir_makefiles), $(info including $(mk) ...)$(eval include $(mk)))
 
-- 
1.9.1

